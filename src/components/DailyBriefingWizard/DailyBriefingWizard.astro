---
---

<div id="setup-wizard" class="wizard-container my-8">
  <!-- Collapsed state (before starting) -->
  <div id="wizard-intro" class="card text-center py-8">
    <h3 class="text-xl font-semibold text-text-primary mb-2">Ready to set up Daily Briefing?</h3>
    <p class="text-text-secondary mb-6">This setup requires Google Calendar API credentials and takes about 10 minutes. You'll need to create a Google Cloud project.</p>
    <button id="start-wizard-btn" class="btn-primary">
      Start Setup
    </button>
  </div>

  <!-- Welcome back state -->
  <div id="wizard-resume" class="card text-center py-8 hidden">
    <h3 class="text-xl font-semibold text-text-primary mb-2">Welcome back!</h3>
    <p class="text-text-secondary mb-6">You were on step <span id="resume-step">1</span> of 6. Let's pick up where you left off!</p>
    <div class="flex justify-center gap-4">
      <button id="continue-wizard-btn" class="btn-primary">Continue Setup</button>
      <button id="restart-wizard-btn" class="btn-secondary">Start Fresh</button>
    </div>
  </div>

  <!-- Active wizard -->
  <div id="wizard-steps" class="hidden">
    <!-- OS Selector -->
    <div class="mb-6 flex items-center gap-2 text-sm">
      <span class="text-text-muted">Showing commands for:</span>
      <select id="os-selector" class="bg-surface border border-border rounded px-2 py-1 text-text-primary">
        <option value="macos">macOS</option>
        <option value="linux">Linux</option>
        <option value="windows">Windows</option>
      </select>
    </div>

    <!-- Step 1: Prerequisites -->
    <div class="wizard-step" data-step="1">
      <div class="step-indicator">
        <div class="step-number">1</div>
        <div class="step-line"></div>
      </div>
      <div class="step-content">
        <h3 class="step-title">Prerequisites</h3>
        <p class="step-description">Let's make sure you have the required tools installed.</p>

        <div class="prereq-check my-4" data-prereq="claude">
          <p class="mb-3">Do you have <strong>Claude Code</strong> installed?</p>
          <div class="flex gap-3">
            <button class="btn-secondary prereq-yes" data-answer="claude-yes">Yes</button>
            <button class="btn-secondary prereq-no" data-answer="claude-no">Not yet</button>
          </div>
          <div class="prereq-help hidden mt-4 p-4 bg-surface rounded-lg border border-border">
            <p class="text-text-secondary mb-3">You'll need Claude Code CLI installed:</p>
            <a href="https://docs.anthropic.com/en/docs/claude-code" target="_blank" class="text-accent hover:underline">
              Install Claude Code →
            </a>
            <button class="btn-primary mt-4 prereq-continue">Done? Continue →</button>
          </div>
        </div>

        <div class="prereq-check my-4 hidden" data-prereq="python">
          <p class="mb-3">Do you have <strong>Python 3.8+</strong> installed?</p>
          <div class="flex gap-3">
            <button class="btn-secondary prereq-yes" data-answer="python-yes">Yes</button>
            <button class="btn-secondary prereq-no" data-answer="python-no">Not sure</button>
          </div>
          <div class="prereq-help hidden mt-4 p-4 bg-surface rounded-lg border border-border">
            <p class="text-text-secondary mb-3">Check your Python version:</p>
            <div id="check-python-cmd"></div>
            <p class="text-text-secondary mt-3 text-sm">If you see a version number (like "Python 3.11.4"), you're good! If not, <a href="https://www.python.org/downloads/" target="_blank" class="text-accent hover:underline">download Python here</a>.</p>
            <button class="btn-primary mt-4 prereq-continue">Done? Continue →</button>
          </div>
        </div>

        <div class="prereq-check my-4 hidden" data-prereq="obsidian">
          <p class="mb-3">Do you have an <strong>Obsidian vault</strong> with a Meetings folder structure?</p>
          <div class="flex gap-3">
            <button class="btn-secondary prereq-yes" data-answer="obsidian-yes">Yes</button>
            <button class="btn-secondary prereq-no" data-answer="obsidian-no">Not yet</button>
          </div>
          <div class="prereq-help hidden mt-4 p-4 bg-surface rounded-lg border border-border">
            <p class="text-text-secondary mb-3">The Daily Briefing command expects meeting notes in:</p>
            <pre class="code-block text-sm my-3"><code>~/Obsidian/Vault/Meetings/YYYY/Q#YY/</code></pre>
            <p class="text-text-secondary text-sm">You can customize these paths in the Claude command file after installation.</p>
            <button class="btn-primary mt-4 prereq-continue">I'll set this up →</button>
          </div>
        </div>

        <button class="step-done-btn btn-primary hidden mt-4" data-next="2">
          Continue to Google API Setup →
        </button>
      </div>
    </div>

    <!-- Step 2: Google Calendar API Setup -->
    <div class="wizard-step opacity-50" data-step="2">
      <div class="step-indicator">
        <div class="step-number">2</div>
        <div class="step-line"></div>
      </div>
      <div class="step-content">
        <h3 class="step-title">Google Calendar API Setup</h3>
        <p class="step-description">Create OAuth credentials in Google Cloud Console.</p>

        <div class="step-body hidden">
          <div class="p-4 bg-surface rounded-lg border border-border mb-4">
            <p class="text-text-secondary mb-3"><strong>Follow the Google Calendar API Quickstart:</strong></p>
            <ol class="list-decimal list-inside text-text-secondary space-y-2 text-sm">
              <li>Go to <a href="https://console.cloud.google.com/apis/enableflow?apiid=calendar-json.googleapis.com" target="_blank" class="text-accent hover:underline">Enable Google Calendar API</a></li>
              <li>Create a new project or select an existing one</li>
              <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-accent hover:underline">APIs & Services → Credentials</a></li>
              <li>Click "Create Credentials" → "OAuth client ID"</li>
              <li>Select "Desktop app" as the application type</li>
              <li>Download the JSON file and rename it to <code>credentials.json</code></li>
            </ol>
          </div>

          <p class="text-text-secondary mb-4">Create the Google credentials directory and place your file there:</p>
          <div id="create-google-dir-cmd"></div>

          <p class="text-text-secondary mt-4 text-sm">Move your downloaded <code>credentials.json</code> file to <code>~/.google/credentials.json</code></p>

          <button class="step-done-btn btn-primary mt-6" data-next="3">
            Credentials are in place →
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Install Python Dependencies -->
    <div class="wizard-step opacity-50" data-step="3">
      <div class="step-indicator">
        <div class="step-number">3</div>
        <div class="step-line"></div>
      </div>
      <div class="step-content">
        <h3 class="step-title">Install Python Dependencies</h3>
        <p class="step-description">Install the Google API libraries.</p>

        <div class="step-body hidden">
          <p class="text-text-secondary mb-4">Run this command to install the required packages:</p>
          <div id="install-deps-cmd"></div>
          <button class="step-done-btn btn-primary mt-6" data-next="4">
            Dependencies installed →
          </button>
        </div>
      </div>
    </div>

    <!-- Step 4: Download Calendar Script -->
    <div class="wizard-step opacity-50" data-step="4">
      <div class="step-indicator">
        <div class="step-number">4</div>
        <div class="step-line"></div>
      </div>
      <div class="step-content">
        <h3 class="step-title">Download Calendar Script</h3>
        <p class="step-description">Get the script that fetches your calendar events.</p>

        <div class="step-body hidden">
          <p class="text-text-secondary mb-4">Download the calendar fetcher script:</p>
          <div id="download-script-cmd"></div>

          <div class="p-4 bg-surface rounded-lg border border-border mt-6">
            <p class="text-text-secondary mb-3"><strong>First-time authentication:</strong></p>
            <p class="text-text-secondary text-sm mb-3">Run the script once to complete OAuth authentication. A browser window will open for you to authorize access:</p>
            <div id="test-script-cmd"></div>
            <p class="text-text-secondary text-sm mt-3">This creates <code>~/.google/token.json</code> which stores your refresh token.</p>
          </div>

          <button class="step-done-btn btn-primary mt-6" data-next="5">
            Authentication complete →
          </button>
        </div>
      </div>
    </div>

    <!-- Step 5: Download Claude Command -->
    <div class="wizard-step opacity-50" data-step="5">
      <div class="step-indicator">
        <div class="step-number">5</div>
        <div class="step-line"></div>
      </div>
      <div class="step-content">
        <h3 class="step-title">Download Claude Command</h3>
        <p class="step-description">Install the /daily-briefing command for Claude Code.</p>

        <div class="step-body hidden">
          <p class="text-text-secondary mb-4">Download the Claude command file:</p>
          <div id="download-command-cmd"></div>

          <p class="text-text-secondary mt-4 text-sm">After downloading, you may want to customize the paths in <code>~/.claude/commands/daily-briefing.md</code> to match your Obsidian vault structure.</p>

          <button class="step-done-btn btn-primary mt-6" data-next="6">
            Command installed →
          </button>
        </div>
      </div>
    </div>

    <!-- Step 6: n8n Workflow (Optional) -->
    <div class="wizard-step opacity-50" data-step="6">
      <div class="step-indicator">
        <div class="step-number">6</div>
        <div class="step-line"></div>
      </div>
      <div class="step-content">
        <h3 class="step-title">Automated Workflow (Optional)</h3>
        <p class="step-description">Set up n8n to generate briefings automatically each morning.</p>

        <div class="step-body hidden">
          <p class="text-text-secondary mb-4">If you use <a href="https://n8n.io" target="_blank" class="text-accent hover:underline">n8n</a> for automation, you can import our workflow to generate daily briefings automatically.</p>

          <div class="p-4 bg-surface rounded-lg border border-border mb-4">
            <p class="font-semibold text-text-primary mb-3">What the workflow does:</p>
            <ul class="list-disc list-inside text-text-secondary space-y-1 text-sm">
              <li>Triggers at 5am on weekdays</li>
              <li>Fetches today's calendar events via the Python script</li>
              <li>Runs the Claude /daily-briefing command</li>
              <li>Saves the output to your Obsidian vault</li>
            </ul>
          </div>

          <div class="p-4 bg-amber-500/10 border border-amber-500/30 rounded-lg mb-4">
            <p class="font-semibold text-amber-400 mb-2">Sections to customize in the workflow:</p>
            <ul class="list-disc list-inside text-text-secondary space-y-2 text-sm">
              <li><strong>SSH Credentials</strong>: Update the SSH node credentials to connect to your machine</li>
              <li><strong>Script Path</strong>: Update <code>~/scripts/ai_scripts/calendar-events/</code> to your script location</li>
              <li><strong>Obsidian Vault Path</strong>: Update <code>~/Obsidian/Vault</code> to your vault location</li>
              <li><strong>Schedule Trigger</strong>: Adjust the 5am weekday schedule if needed</li>
              <li><strong>Claude Wrapper</strong>: Update <code>~/.local/bin/claude-wrapper</code> to your Claude CLI path</li>
            </ul>
          </div>

          <a
            href="/downloads/daily-briefing/Morning briefing.json"
            download
            class="download-btn inline-flex items-center gap-2"
            data-umami-event="download-n8n-workflow"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Download n8n Workflow
          </a>

          <button class="step-done-btn btn-primary mt-6 block" data-next="complete">
            Complete Setup
          </button>

          <button class="btn-secondary mt-3" data-next="complete">
            Skip - I'll run manually
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Completed state -->
  <div id="wizard-complete" class="hidden">
    <div class="card text-center py-8 border-green-500/50">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-500/20 flex items-center justify-center">
        <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <h3 class="text-xl font-semibold text-text-primary mb-2">Setup Complete!</h3>
      <p class="text-text-secondary mb-2">The <code>/daily-briefing</code> command is ready to use.</p>
      <p class="text-text-secondary mb-4">Pipe your calendar data to the command in Claude Code to generate your briefing.</p>
      <p class="text-text-muted text-sm">Scroll down to see usage examples.</p>
      <button id="reset-wizard-btn" class="text-text-muted text-sm mt-4 hover:text-text-secondary underline">
        Need to reinstall? Reset wizard
      </button>
    </div>
  </div>
</div>

<style>
  .wizard-step {
    display: flex;
    gap: 1rem;
    padding-bottom: 1.5rem;
  }

  .step-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
  }

  .step-number {
    width: 2rem;
    height: 2rem;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    background-color: var(--color-surface);
    border: 2px solid var(--color-border);
    color: var(--color-text-muted);
  }

  .wizard-step.active .step-number {
    background-color: var(--color-accent);
    border-color: var(--color-accent);
    color: white;
  }

  .wizard-step.completed .step-number {
    background-color: #22c55e;
    border-color: #22c55e;
    color: white;
  }

  .step-line {
    width: 2px;
    flex-grow: 1;
    background-color: var(--color-border);
    margin-top: 0.5rem;
  }

  .wizard-step.completed .step-line {
    background-color: #22c55e;
  }

  .wizard-step:last-child .step-line {
    display: none;
  }

  .step-content {
    flex-grow: 1;
    padding-bottom: 1rem;
  }

  .step-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 0.25rem;
  }

  .step-description {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .wizard-step.active {
    opacity: 1;
  }

  .wizard-step.active .step-body {
    display: block !important;
  }
</style>

<script>
  import { loadState, saveState, resetState, detectOS, type WizardState } from './wizard.ts';
  import { getCommands } from './commands.ts';

  // DOM Elements
  const wizardIntro = document.getElementById('wizard-intro');
  const wizardResume = document.getElementById('wizard-resume');
  const wizardSteps = document.getElementById('wizard-steps');
  const wizardComplete = document.getElementById('wizard-complete');
  const osSelector = document.getElementById('os-selector') as HTMLSelectElement;
  const resumeStepSpan = document.getElementById('resume-step');

  let state: WizardState;

  function init() {
    state = loadState();

    // Check if returning user
    if (state.currentStep > 0 && state.currentStep <= 6) {
      wizardIntro?.classList.add('hidden');
      wizardResume?.classList.remove('hidden');
      if (resumeStepSpan) resumeStepSpan.textContent = String(state.currentStep);
    } else if (state.currentStep > 6) {
      showComplete();
    }

    // Set OS selector
    if (osSelector) {
      osSelector.value = state.selectedOS;
    }

    updateCommands();
    bindEvents();
  }

  function updateCommands() {
    const cmds = getCommands(state.selectedOS);

    // Update command displays
    updateCommandDisplay('check-python-cmd', cmds.checkPython);
    updateCommandDisplay('create-google-dir-cmd', cmds.createGoogleDir);
    updateCommandDisplay('install-deps-cmd', cmds.installDeps);
    updateCommandDisplay('download-script-cmd', `${cmds.createScriptsDir} && ${cmds.downloadScript}`);
    updateCommandDisplay('test-script-cmd', cmds.testScript);
    updateCommandDisplay('download-command-cmd', `${cmds.createCommandDir} && ${cmds.downloadCommand}`);
  }

  function updateCommandDisplay(id: string, code: string) {
    const container = document.getElementById(id);
    if (container) {
      // Create a simple code block with copy functionality
      container.innerHTML = `
        <div class="copy-wrapper relative group">
          <pre class="code-block pr-12 text-sm"><code>${escapeHtml(code)}</code></pre>
          <button
            type="button"
            class="copy-btn absolute top-2 right-2 p-2 rounded-md bg-surface-elevated border border-border hover:border-accent transition-colors"
            data-code="${escapeAttr(code)}"
            aria-label="Copy to clipboard"
          >
            <svg class="w-4 h-4 copy-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            <svg class="w-4 h-4 check-icon hidden text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </button>
        </div>
      `;

      // Bind copy event
      const btn = container.querySelector('.copy-btn');
      btn?.addEventListener('click', async () => {
        const code = btn.getAttribute('data-code') || '';
        try {
          await navigator.clipboard.writeText(code);
          const wrapper = btn.closest('.copy-wrapper');
          wrapper?.classList.add('copied');
          setTimeout(() => wrapper?.classList.remove('copied'), 2000);
        } catch {
          // Fallback handled by CSS
        }
      });
    }
  }

  function escapeHtml(str: string): string {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function escapeAttr(str: string): string {
    return str.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  function bindEvents() {
    // Start wizard
    document.getElementById('start-wizard-btn')?.addEventListener('click', () => {
      state = { ...state, currentStep: 1, startedAt: new Date().toISOString() };
      saveState(state);
      showWizard();
    });

    // Continue wizard
    document.getElementById('continue-wizard-btn')?.addEventListener('click', showWizard);

    // Restart wizard
    document.getElementById('restart-wizard-btn')?.addEventListener('click', () => {
      state = resetState();
      state.currentStep = 1;
      saveState(state);
      showWizard();
    });

    // Reset wizard
    document.getElementById('reset-wizard-btn')?.addEventListener('click', () => {
      state = resetState();
      wizardComplete?.classList.add('hidden');
      wizardIntro?.classList.remove('hidden');
    });

    // OS selector
    osSelector?.addEventListener('change', () => {
      state.selectedOS = osSelector.value as 'macos' | 'windows' | 'linux';
      saveState(state);
      updateCommands();
    });

    // Prereq yes/no buttons
    document.querySelectorAll('.prereq-yes').forEach(btn => {
      btn.addEventListener('click', () => {
        const check = btn.closest('.prereq-check');
        check?.classList.add('hidden');
        showNextPrereq(check);
      });
    });

    document.querySelectorAll('.prereq-no').forEach(btn => {
      btn.addEventListener('click', () => {
        const check = btn.closest('.prereq-check');
        check?.querySelector('.prereq-help')?.classList.remove('hidden');
        btn.closest('.flex')?.classList.add('hidden');
      });
    });

    document.querySelectorAll('.prereq-continue').forEach(btn => {
      btn.addEventListener('click', () => {
        const check = btn.closest('.prereq-check');
        check?.classList.add('hidden');
        showNextPrereq(check);
      });
    });

    // Step done buttons
    document.querySelectorAll('.step-done-btn, .btn-secondary[data-next]').forEach(btn => {
      btn.addEventListener('click', () => {
        const nextStep = btn.getAttribute('data-next');
        if (nextStep === 'complete') {
          state.currentStep = 7;
          state.completedSteps = [1, 2, 3, 4, 5, 6];
          saveState(state);
          showComplete();
          // Track setup completion in Umami
          if (typeof umami !== 'undefined') {
            umami.track('daily-briefing-setup-complete');
          }
        } else {
          const next = parseInt(nextStep || '1');
          state.currentStep = next;
          state.completedSteps = [...new Set([...state.completedSteps, next - 1])];
          saveState(state);
          updateStepStates();
        }
      });
    });
  }

  function showNextPrereq(currentCheck: Element | null) {
    const prereq = currentCheck?.getAttribute('data-prereq');
    if (prereq === 'claude') {
      const pythonCheck = document.querySelector('[data-prereq="python"]');
      pythonCheck?.classList.remove('hidden');
    } else if (prereq === 'python') {
      const obsidianCheck = document.querySelector('[data-prereq="obsidian"]');
      obsidianCheck?.classList.remove('hidden');
    } else {
      // All prereqs done, show done button
      const doneBtn = currentCheck?.closest('.step-content')?.querySelector('.step-done-btn');
      doneBtn?.classList.remove('hidden');
    }
  }

  function showWizard() {
    wizardIntro?.classList.add('hidden');
    wizardResume?.classList.add('hidden');
    wizardSteps?.classList.remove('hidden');
    updateStepStates();
  }

  function showComplete() {
    wizardIntro?.classList.add('hidden');
    wizardResume?.classList.add('hidden');
    wizardSteps?.classList.add('hidden');
    wizardComplete?.classList.remove('hidden');
  }

  function updateStepStates() {
    document.querySelectorAll('.wizard-step').forEach(step => {
      const stepNum = parseInt(step.getAttribute('data-step') || '0');

      step.classList.remove('active', 'completed', 'opacity-50');

      if (state.completedSteps.includes(stepNum)) {
        step.classList.add('completed');
        step.querySelector('.step-body')?.classList.remove('hidden');
      } else if (stepNum === state.currentStep) {
        step.classList.add('active');
        step.querySelector('.step-body')?.classList.remove('hidden');
      } else {
        step.classList.add('opacity-50');
      }
    });
  }

  // Initialize on load
  init();
</script>
